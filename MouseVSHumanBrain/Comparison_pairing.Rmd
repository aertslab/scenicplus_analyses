---
title: "Comparison multiome versus pairing"
output: html_notebook
---

# 1. Identify high quality regulons per method

## A. ScoMAP

```{r}
library(SCopeLoomR)
library(AUCell)
library(SCENIC)
path <- '/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/ScoMAP/'
loom_path <- paste0(path, 'SCENIC+_gene_based.loom')
loom <- open_loom(loom_path)
cells_AUC <- AUCell::getAUC(get_regulons_AUC(loom, column.attr.name='RegulonsAUC'))
cell_data <- get_cell_annotation(loom)
cell_data$Pseudobulk <- cell_data$GEX_conserved_cell_type
```

```{r}
# Get eRegulons
regulons <- get_regulons(loom, column.attr.name='Regulons')
regulon_list <- list()
for (row in rownames(regulons)){
  regulon_list[[row]] <- colnames(regulons)[which(regulons[row,] == 1)]
}
```

```{r}
out_extended <- vector()
for (name in names(regulon_list)[grep('extended', names(regulon_list))]){
  sub_name <- gsub('_extended', '', name)
  if (sub_name %in% names(regulon_list))
    out_extended <- c(out_extended , name)
}
out_extended <- c(out_extended, names(regulon_list)[grep('+_-', names(regulon_list), fixed=TRUE)], names(regulon_list)[grep('-_-', names(regulon_list), fixed=TRUE)])
```

```{r}
regulon_list <- regulon_list[-which(names(regulon_list) %in% out_extended)]
cells_AUC <- cells_AUC[-which(rownames(cells_AUC) %in% out_extended),]
names(regulon_list) <- gsub('_extended', '', names(regulon_list))
rownames(cells_AUC) <- gsub('_extended', '', rownames(cells_AUC))

names(regulon_list) <- gsub('_+_+', '_+', names(regulon_list), fixed=TRUE)
names(regulon_list) <- gsub('_-_+', '_-', names(regulon_list), fixed=TRUE)
rownames(cells_AUC) <- gsub('_+_+', '_+', rownames(cells_AUC), fixed=TRUE)
rownames(cells_AUC) <- gsub('_-_+', '_-', rownames(cells_AUC), fixed=TRUE)
```

```{r}
saveRDS(regulon_list, file=paste0(path,'regulon_list.RDS'))
```

```{r}
rss_values <- calcRSS(cells_AUC, cell_data$Pseudobulk)
rss_values <- sweep(rss_values,2,colSums(rss_values),`/`)*100
rownames(rss_values) <- gsub('_extended', '', rownames(rss_values))
rss_values <- rss_values[,sort(colnames(rss_values))]
rss_values <- rss_values[,c('CGE LAMP5', 'CGE SNCG', 'CGE VIP', 'MGE PVALB', 'MGE SST', 'L2/3 IT', 'L4 IT', 'L5 IT', 'L5 PT', 'NP', 'L6 IT', 'L6 CT', 'L6b', 'OPC', 'OL', 'AST', 'ENDO', 'MGL')]
```

```{r}
for (name in colnames(rss_values)){
  print(plotRSS_oneSet(rss_values, setName = name, n=30))
}
```

```{r}
library(SCopeLoomR)
loom_path <- paste0(path,'SCENIC+_region_based.loom')
loom <- open_loom(loom_path)
cells_AUC_region <- getAUC(get_regulons_AUC(loom, column.attr.name='RegulonsAUC'))
cells_AUC_region <- cells_AUC_region[-which(rownames(cells_AUC_region) %in% out_extended),]
rownames(cells_AUC_region) <- gsub('_extended', '', rownames(cells_AUC_region) )
rownames(cells_AUC_region) <- gsub('_+_+', '_+', rownames(cells_AUC_region), fixed=TRUE)
rownames(cells_AUC_region) <- gsub('_-_+', '_-', rownames(cells_AUC_region), fixed=TRUE)
```

```{r}
# Get eRegulons
regulons <- get_regulons(loom, column.attr.name='Regulons')
regulon_list <- list()
for (row in rownames(regulons)){
  regulon_list[[row]] <- colnames(regulons)[which(regulons[row,] == 1)]
}
```

```{r}
out_extended <- vector()
for (name in names(regulon_list)[grep('extended', names(regulon_list))]){
  sub_name <- gsub('_extended', '', name)
  if (sub_name %in% names(regulon_list))
    out_extended <- c(out_extended , name)
}
out_extended <- c(out_extended, names(regulon_list)[grep('+_-', names(regulon_list), fixed=TRUE)], names(regulon_list)[grep('-_-', names(regulon_list), fixed=TRUE)])
```

```{r}
regulon_list <- regulon_list[-which(names(regulon_list) %in% out_extended)]
cells_AUC <- cells_AUC[-which(rownames(cells_AUC) %in% out_extended),]
names(regulon_list) <- gsub('_extended', '', names(regulon_list))
rownames(cells_AUC) <- gsub('_extended', '', rownames(cells_AUC))

names(regulon_list) <- gsub('_+_+', '_+', names(regulon_list), fixed=TRUE)
names(regulon_list) <- gsub('_-_+', '_-', names(regulon_list), fixed=TRUE)
rownames(cells_AUC) <- gsub('_+_+', '_+', rownames(cells_AUC), fixed=TRUE)
rownames(cells_AUC) <- gsub('_-_+', '_-', rownames(cells_AUC), fixed=TRUE)
```

```{r}
saveRDS(regulon_list, file=paste0(path,'regulon_list_regions.RDS'))
```

```{r}
cells_AUC <- cells_AUC[rownames(cells_AUC_region), which(colnames(cells_AUC) %in% colnames(cells_AUC_region))]
cells_AUC_region <- cells_AUC_region[rownames(cells_AUC), colnames(cells_AUC)]
correlations <- cor(t(cells_AUC), t(cells_AUC_region))
corre <- diag(correlations)
```

```{r}
x <- regulon_list[names(corre[which(corre > 0.4)])]
x <- x[which(lengths(x) > 35)]
length(x)
```

- How many TFs are only positive, only negative or both?

```{r}
regulon_list <- regulon_list[names(corre[which(corre > 0.4)])]
regulon_list <- regulon_list[which(lengths(regulon_list) > 35)]
both <- sapply(strsplit(names(regulon_list), split = "_"), "[", 1)
both <- both[duplicated(both)]
correlations_both <- diag(correlations[paste0(both, '_-'), paste0(both, '_+')])
names(correlations_both) <- both
both <- names(correlations_both)[which(correlations_both < 0)]
# No out in this case
if (sum(correlations_both > 0) > 0){
  out <- paste0(names(correlations_both)[which(correlations_both > 0)], '_-')
  regulon_list <- regulon_list[-which(names(regulon_list) %in% out)]
}
negative <- names(regulon_list)[-which(names(regulon_list) %in% paste0(both, '_-'))]
negative <- negative[grep('_-', negative)]
positive <- names(regulon_list)[-which(names(regulon_list) %in% paste0(both, '_+'))]
positive <- positive[grep('_+', positive, fixed=TRUE)]
```

```{r}
library(SCopeLoomR)
library(AUCell)
library(SCENIC)
loom_path <- paste0(path,'SCENIC+_gene_based.loom')
loom <- open_loom(loom_path)
dgem <- get_dgem(loom)
cell_data <- get_cell_annotation(loom)
cell_data$Pseudobulk <- cell_data$GEX_conserved_cell_type
cell_data <- cell_data[-which(cell_data$Pseudobulk %in% c('ENDO', 'NP', 'L6 IT CAR3'))]
```

```{r}
saveRDS(cells_AUC, file=paste0(path,'cells_AUC_genebased.RDS'))
```

```{r}
rss_values <- calcRSS(cells_AUC, cell_data$Pseudobulk)
rss_values <- sweep(rss_values,2,colSums(rss_values),`/`)*100
rownames(rss_values) <- gsub('_extended', '', rownames(rss_values))
rss_values <- rss_values[,sort(colnames(rss_values))]
rss_values <- rss_values[,c('CGE LAMP5', 'CGE SNCG', 'CGE VIP', 'MGE PVALB', 'MGE SST', 'L2/3 IT', 'L4 IT', 'L5 IT', 'L5 PT', 'L6 IT', 'L6 CT', 'L6b', 'AST', 'OPC', 'OL', 'MGL')]
```

```{r}
saveRDS(rss_values, file=paste0(path,'rss_values_combined.RDS'))
```

```{r}
expression_list <- list()
for (x in unique(cell_data$Pseudobulk)){
  expression_list[[x]] <- as.data.frame(t(log(rowSums(dgem[,grep(x, cell_data$Pseudobulk)])/sum(rowSums(dgem[,grep(x, cell_data$Pseudobulk)]))*10^6+1)))
}
library(data.table)
exp_mat <- t(rbindlist(expression_list))
colnames(exp_mat) <- names(expression_list)
exp_mat <- exp_mat[,c('CGE LAMP5', 'CGE SNCG', 'CGE VIP', 'MGE PVALB', 'MGE SST', 'L2/3 IT', 'L4 IT', 'L5 IT', 'L5 PT', 'L6 IT', 'L6 CT', 'L6b', 'OPC', 'OL', 'AST', 'MGL')]
```

```{r}
sel_rel <- c(positive, negative, paste0(both, '_+'), paste0(both, '_-'))
order_list <- list()
for (i in 1:ncol(rss_values)){
  order_list[[i]] <- vector()
}
for (x in sel_rel){
  i <- which.max(rss_values[x,])
  order_list[[i]] <- c(order_list[[i]], x)
}
sel_rel <- unlist(order_list)
```

```{r}
rss_values <- t(apply(rss_values, 1, function(x)(x-min(x))/(max(x)-min(x))))
exp_mat <- t(scale(t(exp_mat)))
rel_list <- sel_rel
rel_data <- data.frame()
for (rel in rel_list){
  for (name in colnames(rss_values)){
      tf <- strsplit(rel, split = "_")[[1]][1]
      row_to_add <- t(c(rel, name, exp_mat[tf, name], rss_values[rel,name]))
      rel_data <- rbind(rel_data, row_to_add)
   }
}
colnames(rel_data) <- c('Regulon', 'Cell_type', 'Expression', 'RSS')
sel_rel_color <- rep('grey',length(sel_rel))
sel_rel_color[which(sel_rel %in% positive)] <- 'forestgreen'
sel_rel_color[which(sel_rel %in% negative)] <- 'red'
```

```{r}
saveRDS(sel_rel, file=paste0(path,'HQ_regulons.RDS'))
saveRDS(rel_data, file=paste0(path,'rel_data.RDS'))
```

```{r}
sel_rel <- readRDS(paste0(path,'HQ_regulons.RDS'))
write.table(sel_rel, paste0(path,'HQ_regulons.tsv'), quote=FALSE, col.names = FALSE, row.names = FALSE)
```

```{r}
library(ggplot2)
rel_data$Regulon <- factor(rel_data$Regulon, levels=sel_rel)
rel_data$Cell_type <- factor(rel_data$Cell_type, levels=rev(colnames(rss_values)))
rel_data$RSS <- as.numeric(rel_data$RSS)
rel_data$Expression <- as.numeric(rel_data$Expression)
rel_data$Repressor_activator <- unlist(lapply(grepl("+", rel_data$Regulon, fixed=TRUE), function(x) if (x) 'Activators' else 'Repressors'))
g <- ggplot(data = rel_data, mapping = aes_string(y = 'Cell_type', x = 'Regulon')) +
    facet_grid(cols = vars(Repressor_activator), scales = "free_x", space = 'free') +
    geom_tile(mapping = aes_string(fill = 'Expression')) +
    geom_point(mapping = aes_string(size = 'RSS'), colour="black",pch=21, fill = 'black') +
    scale_radius(range = c(0.1, 5), limits=c(0.8, 1)) +
    scale_fill_distiller(palette = "RdYlBu") +
    theme_bw() +
    theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1))
print(g)
ggsave(paste0(path, 'Regulon_dotplot_all_RSS_suppl_all_celltypes.pdf'), g, width=18, height=6)
```

```{r}
library(ggplot2)
rel_data$Regulon <- factor(rel_data$Regulon, levels=sel_rel)
rel_data$Cell_type <- factor(rel_data$Cell_type, levels=rev(colnames(rss_values)))
rel_data$RSS <- as.numeric(rel_data$RSS)
rel_data$Expression <- as.numeric(rel_data$Expression)
rel_data$Repressor_activator <- unlist(lapply(grepl("+", rel_data$Regulon, fixed=TRUE), function(x) if (x) 'Activators' else 'Repressors'))
g <- ggplot(data = rel_data, mapping = aes_string(y = 'Cell_type', x = 'Regulon')) +
    facet_grid(cols = vars(Repressor_activator), scales = "free_x", space = 'free') +
    geom_tile(mapping = aes_string(fill = 'Expression')) +
    geom_point(mapping = aes_string(size = 'RSS'), colour="black",pch=21, fill = 'black') +
    scale_radius(range = c(0.1, 5), limits=c(0, 1)) +
    scale_fill_distiller(palette = "RdYlBu") +
    theme_bw() +
    theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1))
print(g)
ggsave(paste0(path,'Regulon_dotplot_all_RSS_suppl_all_celltypes_nothr.pdf'), g, width=18, height=6)
```

## B. FigR

```{r}
library(SCopeLoomR)
library(AUCell)
library(SCENIC)
path <- '/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/FigR/'
loom_path <- paste0(path, 'SCENIC+_gene_based.loom')
loom <- open_loom(loom_path)
cells_AUC <- AUCell::getAUC(get_regulons_AUC(loom, column.attr.name='RegulonsAUC'))
cell_data <- get_cell_annotation(loom)
cell_data$Pseudobulk <- cell_data$GEX_conserved_cell_type
```

```{r}
# Get eRegulons
regulons <- get_regulons(loom, column.attr.name='Regulons')
regulon_list <- list()
for (row in rownames(regulons)){
  regulon_list[[row]] <- colnames(regulons)[which(regulons[row,] == 1)]
}
```

```{r}
out_extended <- vector()
for (name in names(regulon_list)[grep('extended', names(regulon_list))]){
  sub_name <- gsub('_extended', '', name)
  if (sub_name %in% names(regulon_list))
    out_extended <- c(out_extended , name)
}
out_extended <- c(out_extended, names(regulon_list)[grep('+_-', names(regulon_list), fixed=TRUE)], names(regulon_list)[grep('-_-', names(regulon_list), fixed=TRUE)])
```

```{r}
regulon_list <- regulon_list[-which(names(regulon_list) %in% out_extended)]
cells_AUC <- cells_AUC[-which(rownames(cells_AUC) %in% out_extended),]
names(regulon_list) <- gsub('_extended', '', names(regulon_list))
rownames(cells_AUC) <- gsub('_extended', '', rownames(cells_AUC))

names(regulon_list) <- gsub('_+_+', '_+', names(regulon_list), fixed=TRUE)
names(regulon_list) <- gsub('_-_+', '_-', names(regulon_list), fixed=TRUE)
rownames(cells_AUC) <- gsub('_+_+', '_+', rownames(cells_AUC), fixed=TRUE)
rownames(cells_AUC) <- gsub('_-_+', '_-', rownames(cells_AUC), fixed=TRUE)
```

```{r}
saveRDS(regulon_list, file=paste0(path,'regulon_list.RDS'))
```

```{r}
rss_values <- calcRSS(cells_AUC, cell_data$Pseudobulk)
rss_values <- sweep(rss_values,2,colSums(rss_values),`/`)*100
rownames(rss_values) <- gsub('_extended', '', rownames(rss_values))
rss_values <- rss_values[,sort(colnames(rss_values))]
rss_values <- rss_values[,c('CGE LAMP5', 'CGE SNCG', 'CGE VIP', 'MGE PVALB', 'MGE SST', 'L2/3 IT', 'L4 IT', 'L5 IT', 'L5 PT', 'NP', 'L6 IT', 'L6 CT', 'L6b', 'OPC', 'OL', 'AST', 'ENDO', 'MGL')]
```

```{r}
for (name in colnames(rss_values)){
  print(plotRSS_oneSet(rss_values, setName = name, n=30))
}
```

```{r}
library(SCopeLoomR)
loom_path <- paste0(path,'SCENIC+_region_based.loom')
loom <- open_loom(loom_path)
cells_AUC_region <- getAUC(get_regulons_AUC(loom, column.attr.name='RegulonsAUC'))
cells_AUC_region <- cells_AUC_region[-which(rownames(cells_AUC_region) %in% out_extended),]
rownames(cells_AUC_region) <- gsub('_extended', '', rownames(cells_AUC_region) )
rownames(cells_AUC_region) <- gsub('_+_+', '_+', rownames(cells_AUC_region), fixed=TRUE)
rownames(cells_AUC_region) <- gsub('_-_+', '_-', rownames(cells_AUC_region), fixed=TRUE)
```

```{r}
# Get eRegulons
regulons <- get_regulons(loom, column.attr.name='Regulons')
regulon_list <- list()
for (row in rownames(regulons)){
  regulon_list[[row]] <- colnames(regulons)[which(regulons[row,] == 1)]
}
```

```{r}
out_extended <- vector()
for (name in names(regulon_list)[grep('extended', names(regulon_list))]){
  sub_name <- gsub('_extended', '', name)
  if (sub_name %in% names(regulon_list))
    out_extended <- c(out_extended , name)
}
out_extended <- c(out_extended, names(regulon_list)[grep('+_-', names(regulon_list), fixed=TRUE)], names(regulon_list)[grep('-_-', names(regulon_list), fixed=TRUE)])
```

```{r}
regulon_list <- regulon_list[-which(names(regulon_list) %in% out_extended)]
cells_AUC <- cells_AUC[-which(rownames(cells_AUC) %in% out_extended),]
names(regulon_list) <- gsub('_extended', '', names(regulon_list))
rownames(cells_AUC) <- gsub('_extended', '', rownames(cells_AUC))

names(regulon_list) <- gsub('_+_+', '_+', names(regulon_list), fixed=TRUE)
names(regulon_list) <- gsub('_-_+', '_-', names(regulon_list), fixed=TRUE)
rownames(cells_AUC) <- gsub('_+_+', '_+', rownames(cells_AUC), fixed=TRUE)
rownames(cells_AUC) <- gsub('_-_+', '_-', rownames(cells_AUC), fixed=TRUE)
```

```{r}
saveRDS(regulon_list, file=paste0(path,'regulon_list_regions.RDS'))
```

```{r}
cells_AUC <- cells_AUC[rownames(cells_AUC_region), which(colnames(cells_AUC) %in% colnames(cells_AUC_region))]
cells_AUC_region <- cells_AUC_region[rownames(cells_AUC), colnames(cells_AUC)]
correlations <- cor(t(cells_AUC), t(cells_AUC_region))
corre <- diag(correlations)
```

```{r}
x <- regulon_list[names(corre[which(corre > 0.4)])]
x <- x[which(lengths(x) > 35)]
length(x)
```

- How many TFs are only positive, only negative or both?

```{r}
regulon_list <- regulon_list[names(corre[which(corre > 0.4)])]
regulon_list <- regulon_list[which(lengths(regulon_list) > 35)]
both <- sapply(strsplit(names(regulon_list), split = "_"), "[", 1)
both <- both[duplicated(both)]
correlations_both <- diag(correlations[paste0(both, '_-'), paste0(both, '_+')])
names(correlations_both) <- both
both <- names(correlations_both)[which(correlations_both < 0)]
# No out in this case
if (sum(correlations_both > 0) > 0){
  out <- paste0(names(correlations_both)[which(correlations_both > 0)], '_-')
  regulon_list <- regulon_list[-which(names(regulon_list) %in% out)]
}
negative <- names(regulon_list)[-which(names(regulon_list) %in% paste0(both, '_-'))]
negative <- negative[grep('_-', negative)]
positive <- names(regulon_list)[-which(names(regulon_list) %in% paste0(both, '_+'))]
positive <- positive[grep('_+', positive, fixed=TRUE)]
```

```{r}
library(SCopeLoomR)
library(AUCell)
library(SCENIC)
loom_path <- paste0(path,'SCENIC+_gene_based.loom')
loom <- open_loom(loom_path)
dgem <- get_dgem(loom)
cell_data <- get_cell_annotation(loom)
cell_data$Pseudobulk <- cell_data$GEX_conserved_cell_type
cell_data <- cell_data[-which(cell_data$Pseudobulk %in% c('ENDO', 'NP', 'L6 IT CAR3'))]
```

```{r}
saveRDS(cells_AUC, file=paste0(path,'cells_AUC_genebased.RDS'))
```

```{r}
rss_values <- calcRSS(cells_AUC, cell_data$Pseudobulk)
rss_values <- sweep(rss_values,2,colSums(rss_values),`/`)*100
rownames(rss_values) <- gsub('_extended', '', rownames(rss_values))
rss_values <- rss_values[,sort(colnames(rss_values))]
rss_values <- rss_values[,c('CGE LAMP5', 'CGE SNCG', 'CGE VIP', 'MGE PVALB', 'MGE SST', 'L2/3 IT', 'L4 IT', 'L5 IT', 'L5 PT', 'L6 IT', 'L6 CT', 'L6b', 'AST', 'OPC', 'OL', 'MGL')]
```

```{r}
saveRDS(rss_values, file=paste0(path,'rss_values_combined.RDS'))
```

```{r}
expression_list <- list()
for (x in unique(cell_data$Pseudobulk)){
  expression_list[[x]] <- as.data.frame(t(log(rowSums(dgem[,grep(x, cell_data$Pseudobulk)])/sum(rowSums(dgem[,grep(x, cell_data$Pseudobulk)]))*10^6+1)))
}
library(data.table)
exp_mat <- t(rbindlist(expression_list))
colnames(exp_mat) <- names(expression_list)
exp_mat <- exp_mat[,c('CGE LAMP5', 'CGE SNCG', 'CGE VIP', 'MGE PVALB', 'MGE SST', 'L2/3 IT', 'L4 IT', 'L5 IT', 'L5 PT', 'L6 IT', 'L6 CT', 'L6b', 'OPC', 'OL', 'AST', 'MGL')]
```

```{r}
sel_rel <- c(positive, negative, paste0(both, '_+'), paste0(both, '_-'))
order_list <- list()
for (i in 1:ncol(rss_values)){
  order_list[[i]] <- vector()
}
for (x in sel_rel){
  i <- which.max(rss_values[x,])
  order_list[[i]] <- c(order_list[[i]], x)
}
sel_rel <- unlist(order_list)
```

```{r}
rss_values <- t(apply(rss_values, 1, function(x)(x-min(x))/(max(x)-min(x))))
exp_mat <- t(scale(t(exp_mat)))
rel_list <- sel_rel
rel_data <- data.frame()
for (rel in rel_list){
  for (name in colnames(rss_values)){
      tf <- strsplit(rel, split = "_")[[1]][1]
      row_to_add <- t(c(rel, name, exp_mat[tf, name], rss_values[rel,name]))
      rel_data <- rbind(rel_data, row_to_add)
   }
}
colnames(rel_data) <- c('Regulon', 'Cell_type', 'Expression', 'RSS')
sel_rel_color <- rep('grey',length(sel_rel))
sel_rel_color[which(sel_rel %in% positive)] <- 'forestgreen'
sel_rel_color[which(sel_rel %in% negative)] <- 'red'
```

```{r}
saveRDS(sel_rel, file=paste0(path,'HQ_regulons.RDS'))
saveRDS(rel_data, file=paste0(path,'rel_data.RDS'))
```

```{r}
sel_rel <- readRDS(paste0(path,'HQ_regulons.RDS'))
write.table(sel_rel, paste0(path,'HQ_regulons.tsv'), quote=FALSE, col.names = FALSE, row.names = FALSE)
```

```{r}
library(ggplot2)
rel_data$Regulon <- factor(rel_data$Regulon, levels=sel_rel)
rel_data$Cell_type <- factor(rel_data$Cell_type, levels=rev(colnames(rss_values)))
rel_data$RSS <- as.numeric(rel_data$RSS)
rel_data$Expression <- as.numeric(rel_data$Expression)
rel_data$Repressor_activator <- unlist(lapply(grepl("+", rel_data$Regulon, fixed=TRUE), function(x) if (x) 'Activators' else 'Repressors'))
g <- ggplot(data = rel_data, mapping = aes_string(y = 'Cell_type', x = 'Regulon')) +
    facet_grid(cols = vars(Repressor_activator), scales = "free_x", space = 'free') +
    geom_tile(mapping = aes_string(fill = 'Expression')) +
    geom_point(mapping = aes_string(size = 'RSS'), colour="black",pch=21, fill = 'black') +
    scale_radius(range = c(0.1, 5), limits=c(0.8, 1)) +
    scale_fill_distiller(palette = "RdYlBu") +
    theme_bw() +
    theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1))
print(g)
ggsave(paste0(path, 'Regulon_dotplot_all_RSS_suppl_all_celltypes.pdf'), g, width=18, height=6)
```

```{r}
library(ggplot2)
rel_data$Regulon <- factor(rel_data$Regulon, levels=sel_rel)
rel_data$Cell_type <- factor(rel_data$Cell_type, levels=rev(colnames(rss_values)))
rel_data$RSS <- as.numeric(rel_data$RSS)
rel_data$Expression <- as.numeric(rel_data$Expression)
rel_data$Repressor_activator <- unlist(lapply(grepl("+", rel_data$Regulon, fixed=TRUE), function(x) if (x) 'Activators' else 'Repressors'))
g <- ggplot(data = rel_data, mapping = aes_string(y = 'Cell_type', x = 'Regulon')) +
    facet_grid(cols = vars(Repressor_activator), scales = "free_x", space = 'free') +
    geom_tile(mapping = aes_string(fill = 'Expression')) +
    geom_point(mapping = aes_string(size = 'RSS'), colour="black",pch=21, fill = 'black') +
    scale_radius(range = c(0.1, 5), limits=c(0, 1)) +
    scale_fill_distiller(palette = "RdYlBu") +
    theme_bw() +
    theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1))
print(g)
ggsave(paste0(path,'Regulon_dotplot_all_RSS_suppl_all_celltypes_nothr.pdf'), g, width=18, height=6)
```
## C. SCENIC+ 

```{r}
library(SCopeLoomR)
library(AUCell)
library(SCENIC)
path <- '/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/SCENIC/'
loom_path <- paste0(path, 'SCENIC+_gene_based.loom')
loom <- open_loom(loom_path)
cells_AUC <- AUCell::getAUC(get_regulons_AUC(loom, column.attr.name='RegulonsAUC'))
cell_data <- get_cell_annotation(loom)
cell_data$Pseudobulk <- cell_data$GEX_conserved_cell_type
```

```{r}
# Get eRegulons
regulons <- get_regulons(loom, column.attr.name='Regulons')
regulon_list <- list()
for (row in rownames(regulons)){
  regulon_list[[row]] <- colnames(regulons)[which(regulons[row,] == 1)]
}
```

```{r}
out_extended <- vector()
for (name in names(regulon_list)[grep('extended', names(regulon_list))]){
  sub_name <- gsub('_extended', '', name)
  if (sub_name %in% names(regulon_list))
    out_extended <- c(out_extended , name)
}
out_extended <- c(out_extended, names(regulon_list)[grep('+_-', names(regulon_list), fixed=TRUE)], names(regulon_list)[grep('-_-', names(regulon_list), fixed=TRUE)])
```

```{r}
regulon_list <- regulon_list[-which(names(regulon_list) %in% out_extended)]
cells_AUC <- cells_AUC[-which(rownames(cells_AUC) %in% out_extended),]
names(regulon_list) <- gsub('_extended', '', names(regulon_list))
rownames(cells_AUC) <- gsub('_extended', '', rownames(cells_AUC))

names(regulon_list) <- gsub('_+_+', '_+', names(regulon_list), fixed=TRUE)
names(regulon_list) <- gsub('_-_+', '_-', names(regulon_list), fixed=TRUE)
rownames(cells_AUC) <- gsub('_+_+', '_+', rownames(cells_AUC), fixed=TRUE)
rownames(cells_AUC) <- gsub('_-_+', '_-', rownames(cells_AUC), fixed=TRUE)
```

```{r}
saveRDS(regulon_list, file=paste0(path,'regulon_list.RDS'))
```

```{r}
rss_values <- calcRSS(cells_AUC, cell_data$Pseudobulk)
rss_values <- sweep(rss_values,2,colSums(rss_values),`/`)*100
rownames(rss_values) <- gsub('_extended', '', rownames(rss_values))
rss_values <- rss_values[,sort(colnames(rss_values))]
rss_values <- rss_values[,c('CGE LAMP5', 'CGE SNCG', 'CGE VIP', 'MGE PVALB', 'MGE SST', 'L2/3 IT', 'L4 IT', 'L5 IT', 'L5 PT', 'NP', 'L6 IT', 'L6 CT', 'L6b', 'OPC', 'OL', 'AST', 'ENDO', 'MGL')]
```

```{r}
for (name in colnames(rss_values)){
  print(plotRSS_oneSet(rss_values, setName = name, n=30))
}
```

```{r}
library(SCopeLoomR)
loom_path <- paste0(path,'SCENIC+_region_based.loom')
loom <- open_loom(loom_path)
cells_AUC_region <- getAUC(get_regulons_AUC(loom, column.attr.name='RegulonsAUC'))
cells_AUC_region <- cells_AUC_region[-which(rownames(cells_AUC_region) %in% out_extended),]
rownames(cells_AUC_region) <- gsub('_extended', '', rownames(cells_AUC_region) )
rownames(cells_AUC_region) <- gsub('_+_+', '_+', rownames(cells_AUC_region), fixed=TRUE)
rownames(cells_AUC_region) <- gsub('_-_+', '_-', rownames(cells_AUC_region), fixed=TRUE)
```

```{r}
# Get eRegulons
regulons <- get_regulons(loom, column.attr.name='Regulons')
regulon_list <- list()
for (row in rownames(regulons)){
  regulon_list[[row]] <- colnames(regulons)[which(regulons[row,] == 1)]
}
```

```{r}
out_extended <- vector()
for (name in names(regulon_list)[grep('extended', names(regulon_list))]){
  sub_name <- gsub('_extended', '', name)
  if (sub_name %in% names(regulon_list))
    out_extended <- c(out_extended , name)
}
out_extended <- c(out_extended, names(regulon_list)[grep('+_-', names(regulon_list), fixed=TRUE)], names(regulon_list)[grep('-_-', names(regulon_list), fixed=TRUE)])
```

```{r}
regulon_list <- regulon_list[-which(names(regulon_list) %in% out_extended)]
cells_AUC <- cells_AUC[-which(rownames(cells_AUC) %in% out_extended),]
names(regulon_list) <- gsub('_extended', '', names(regulon_list))
rownames(cells_AUC) <- gsub('_extended', '', rownames(cells_AUC))

names(regulon_list) <- gsub('_+_+', '_+', names(regulon_list), fixed=TRUE)
names(regulon_list) <- gsub('_-_+', '_-', names(regulon_list), fixed=TRUE)
rownames(cells_AUC) <- gsub('_+_+', '_+', rownames(cells_AUC), fixed=TRUE)
rownames(cells_AUC) <- gsub('_-_+', '_-', rownames(cells_AUC), fixed=TRUE)
```

```{r}
saveRDS(regulon_list, file=paste0(path,'regulon_list_regions.RDS'))
```

```{r}
cells_AUC <- cells_AUC[rownames(cells_AUC_region), which(colnames(cells_AUC) %in% colnames(cells_AUC_region))]
cells_AUC_region <- cells_AUC_region[rownames(cells_AUC), colnames(cells_AUC)]
correlations <- cor(t(cells_AUC), t(cells_AUC_region))
corre <- diag(correlations)
```

```{r}
x <- regulon_list[names(corre[which(corre > 0.4)])]
x <- x[which(lengths(x) > 35)]
length(x)
```

- How many TFs are only positive, only negative or both?

```{r}
regulon_list <- regulon_list[names(corre[which(corre > 0.4)])]
regulon_list <- regulon_list[which(lengths(regulon_list) > 35)]
both <- sapply(strsplit(names(regulon_list), split = "_"), "[", 1)
both <- both[duplicated(both)]
correlations_both <- diag(correlations[paste0(both, '_-'), paste0(both, '_+')])
names(correlations_both) <- both
both <- names(correlations_both)[which(correlations_both < 0)]
# No out in this case
if (sum(correlations_both > 0) > 0){
  out <- paste0(names(correlations_both)[which(correlations_both > 0)], '_-')
  regulon_list <- regulon_list[-which(names(regulon_list) %in% out)]
}
negative <- names(regulon_list)[-which(names(regulon_list) %in% paste0(both, '_-'))]
negative <- negative[grep('_-', negative)]
positive <- names(regulon_list)[-which(names(regulon_list) %in% paste0(both, '_+'))]
positive <- positive[grep('_+', positive, fixed=TRUE)]
```

```{r}
library(SCopeLoomR)
library(AUCell)
library(SCENIC)
loom_path <- paste0(path,'SCENIC+_gene_based.loom')
loom <- open_loom(loom_path)
dgem <- get_dgem(loom)
cell_data <- get_cell_annotation(loom)
cell_data$Pseudobulk <- cell_data$GEX_conserved_cell_type
cell_data <- cell_data[-which(cell_data$Pseudobulk %in% c('ENDO', 'NP', 'L6 IT CAR3'))]
```

```{r}
saveRDS(cells_AUC, file=paste0(path,'cells_AUC_genebased.RDS'))
```

```{r}
rss_values <- calcRSS(cells_AUC, cell_data$Pseudobulk)
rss_values <- sweep(rss_values,2,colSums(rss_values),`/`)*100
rownames(rss_values) <- gsub('_extended', '', rownames(rss_values))
rss_values <- rss_values[,sort(colnames(rss_values))]
rss_values <- rss_values[,c('CGE LAMP5', 'CGE SNCG', 'CGE VIP', 'MGE PVALB', 'MGE SST', 'L2/3 IT', 'L4 IT', 'L5 IT', 'L5 PT', 'L6 IT', 'L6 CT', 'L6b', 'AST', 'OPC', 'OL', 'MGL')]
```

```{r}
saveRDS(rss_values, file=paste0(path,'rss_values_combined.RDS'))
```

```{r}
expression_list <- list()
for (x in unique(cell_data$Pseudobulk)){
  expression_list[[x]] <- as.data.frame(t(log(rowSums(dgem[,grep(x, cell_data$Pseudobulk)])/sum(rowSums(dgem[,grep(x, cell_data$Pseudobulk)]))*10^6+1)))
}
library(data.table)
exp_mat <- t(rbindlist(expression_list))
colnames(exp_mat) <- names(expression_list)
exp_mat <- exp_mat[,c('CGE LAMP5', 'CGE SNCG', 'CGE VIP', 'MGE PVALB', 'MGE SST', 'L2/3 IT', 'L4 IT', 'L5 IT', 'L5 PT', 'L6 IT', 'L6 CT', 'L6b', 'OPC', 'OL', 'AST', 'MGL')]
```

```{r}
sel_rel <- c(positive, negative, paste0(both, '_+'), paste0(both, '_-'))
order_list <- list()
for (i in 1:ncol(rss_values)){
  order_list[[i]] <- vector()
}
for (x in sel_rel){
  i <- which.max(rss_values[x,])
  order_list[[i]] <- c(order_list[[i]], x)
}
sel_rel <- unlist(order_list)
```

```{r}
rss_values <- t(apply(rss_values, 1, function(x)(x-min(x))/(max(x)-min(x))))
exp_mat <- t(scale(t(exp_mat)))
rel_list <- sel_rel
rel_data <- data.frame()
for (rel in rel_list){
  for (name in colnames(rss_values)){
      tf <- strsplit(rel, split = "_")[[1]][1]
      row_to_add <- t(c(rel, name, exp_mat[tf, name], rss_values[rel,name]))
      rel_data <- rbind(rel_data, row_to_add)
   }
}
colnames(rel_data) <- c('Regulon', 'Cell_type', 'Expression', 'RSS')
sel_rel_color <- rep('grey',length(sel_rel))
sel_rel_color[which(sel_rel %in% positive)] <- 'forestgreen'
sel_rel_color[which(sel_rel %in% negative)] <- 'red'
```

```{r}
saveRDS(sel_rel, file=paste0(path,'HQ_regulons.RDS'))
saveRDS(rel_data, file=paste0(path,'rel_data.RDS'))
```

```{r}
sel_rel <- readRDS(paste0(path,'HQ_regulons.RDS'))
write.table(sel_rel, paste0(path,'HQ_regulons.tsv'), quote=FALSE, col.names = FALSE, row.names = FALSE)
```

```{r}
library(ggplot2)
rel_data$Regulon <- factor(rel_data$Regulon, levels=sel_rel)
rel_data$Cell_type <- factor(rel_data$Cell_type, levels=rev(colnames(rss_values)))
rel_data$RSS <- as.numeric(rel_data$RSS)
rel_data$Expression <- as.numeric(rel_data$Expression)
rel_data$Repressor_activator <- unlist(lapply(grepl("+", rel_data$Regulon, fixed=TRUE), function(x) if (x) 'Activators' else 'Repressors'))
g <- ggplot(data = rel_data, mapping = aes_string(y = 'Cell_type', x = 'Regulon')) +
    facet_grid(cols = vars(Repressor_activator), scales = "free_x", space = 'free') +
    geom_tile(mapping = aes_string(fill = 'Expression')) +
    geom_point(mapping = aes_string(size = 'RSS'), colour="black",pch=21, fill = 'black') +
    scale_radius(range = c(0.1, 5), limits=c(0.8, 1)) +
    scale_fill_distiller(palette = "RdYlBu") +
    theme_bw() +
    theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1))
print(g)
ggsave(paste0(path, 'Regulon_dotplot_all_RSS_suppl_all_celltypes.pdf'), g, width=18, height=6)
```
# 2. Regulon heatmap

```{r}
TFs <- list()
TFs[['Multiome']] <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/HQ_regulons.RDS')
TFs[['ScoMAP']] <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/ScoMAP/HQ_regulons.RDS')
TFs[['FigR']] <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/FigR/HQ_regulons.RDS')
TFs[['SCENIC+']] <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/SCENIC/HQ_regulons.RDS')
TFs[['Random']] <- vector()

for (name in names(TFs)){
  TFs[[name]] <- unique(substr(TFs[[name]], 1, nchar(TFs[[name]])-2))
}

```

```{r}
library(RVenn)
toy  <- Venn(TFs)
setmap(toy, method = "complete")
```

```{r}
pdf('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/overlap_between_methods_all.pdf', height=16, width=8)
setmap(toy, method = "complete")
dev.off()
```

```{r}
pdf('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/overlap_between_methods_all_Upset_R.pdf')
library(UpSetR)
upset(fromList(TFs), order.by = "freq")
dev.off()
```

# 3. Overlap between regulons (genes)

## A. ScoMAP

```{r}
ref_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/regulon_list.RDS')
sel_rel <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/HQ_regulons.RDS')
query_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/ScoMAP/regulon_list.RDS')
sel_rel_2 <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/ScoMAP/HQ_regulons.RDS')
sel_rel <- sel_rel[which(sel_rel %in% sel_rel_2)]
ref_regulon_list <- ref_regulon_list[sel_rel]
query_regulon_list <- query_regulon_list[sel_rel]

jaccard <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a) + length(b) - intersection
    return (intersection/union)
}

jaccard_a <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a)
    return (intersection/union)
}

jaccard_b <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(b)
    return (intersection/union)
}

vector_list <- list()
for (name1 in names(ref_regulon_list)){
  vec <- vector()
  for (name2 in names(ref_regulon_list)){
    vec <- c(vec, jaccard(ref_regulon_list[[name1]], query_regulon_list[[name2]]))
  }
  vector_list[[name1]] <- data.frame(t(vec))
}
jaccard_matrix <- as.matrix(rbindlist(vector_list))
colnames(jaccard_matrix) <- names(ref_regulon_list)
rownames(jaccard_matrix) <- names(ref_regulon_list)
saveRDS(diag(jaccard_matrix), file='/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/ScoMAP/jaccard_genes.RDS')
jaccard_matrix <- as.data.frame(jaccard_matrix)

jaccard_matrix <- round(jaccard_matrix,2)

library(reshape2)
library(ggplot2)
# Format matrix
jaccard_matrix$Multiome <- rownames(jaccard_matrix)
melted_jaccard_matrix <- melt(jaccard_matrix)
colnames(melted_jaccard_matrix)[2] <- 'ScoMAP'
melted_jaccard_matrix$ScoMAP <- factor(melted_jaccard_matrix$ScoMAP, levels=unique(melted_jaccard_matrix$ScoMAP))
melted_jaccard_matrix$Multiome <- factor(melted_jaccard_matrix$Multiome, levels=unique(melted_jaccard_matrix$Multiome))
# Create heatmap
ggheatmap <- ggplot(melted_jaccard_matrix, aes(ScoMAP, Multiome, fill = value))+
   scale_fill_gradient2(low = "dodgerblue", high = "red", mid = "white", space = "Lab", 
    name="Jaccard") +
 geom_tile(color = "white")+
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 10, hjust = 1))+
 coord_fixed()
pdf('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/genes_multiome_vs_ScoMAP.pdf')
ggheatmap
dev.off()
```


## B. FigR

```{r}
ref_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/regulon_list.RDS')
sel_rel <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/HQ_regulons.RDS')
query_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/FigR/regulon_list.RDS')
sel_rel_2 <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/FigR/HQ_regulons.RDS')
sel_rel <- sel_rel[which(sel_rel %in% sel_rel_2)]
ref_regulon_list <- ref_regulon_list[sel_rel]
query_regulon_list <- query_regulon_list[sel_rel]

jaccard <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a) + length(b) - intersection
    return (intersection/union)
}

jaccard_a <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a)
    return (intersection/union)
}

jaccard_b <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(b)
    return (intersection/union)
}

vector_list <- list()
for (name1 in names(ref_regulon_list)){
  vec <- vector()
  for (name2 in names(ref_regulon_list)){
    vec <- c(vec, jaccard(ref_regulon_list[[name1]], query_regulon_list[[name2]]))
  }
  vector_list[[name1]] <- data.frame(t(vec))
}
jaccard_matrix <- as.matrix(rbindlist(vector_list))
colnames(jaccard_matrix) <- names(ref_regulon_list)
rownames(jaccard_matrix) <- names(ref_regulon_list)
saveRDS(diag(jaccard_matrix), file='/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/FigR/jaccard_genes.RDS')
jaccard_matrix <- as.data.frame(jaccard_matrix)

jaccard_matrix <- round(jaccard_matrix,2)

library(reshape2)
library(ggplot2)
# Format matrix
jaccard_matrix$Multiome <- rownames(jaccard_matrix)
melted_jaccard_matrix <- melt(jaccard_matrix)
colnames(melted_jaccard_matrix)[2] <- 'FigR'
melted_jaccard_matrix$FigR <- factor(melted_jaccard_matrix$FigR, levels=unique(melted_jaccard_matrix$FigR))
melted_jaccard_matrix$Multiome <- factor(melted_jaccard_matrix$Multiome, levels=unique(melted_jaccard_matrix$Multiome))
# Create heatmap
ggheatmap <- ggplot(melted_jaccard_matrix, aes(FigR, Multiome, fill = value))+
   scale_fill_gradient2(low = "dodgerblue", high = "red", mid = "white", space = "Lab", 
    name="Jaccard") +
 geom_tile(color = "white")+
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 10, hjust = 1))+
 coord_fixed()
pdf('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/genes_multiome_vs_FigR.pdf')
ggheatmap
dev.off()
```



## C. SCENIC

```{r}
ref_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/regulon_list.RDS')
sel_rel <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/HQ_regulons.RDS')
query_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/SCENIC/regulon_list.RDS')
sel_rel_2 <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/SCENIC/HQ_regulons.RDS')
sel_rel <- sel_rel[which(sel_rel %in% sel_rel_2)]
ref_regulon_list <- ref_regulon_list[sel_rel]
query_regulon_list <- query_regulon_list[sel_rel]

jaccard <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a) + length(b) - intersection
    return (intersection/union)
}

jaccard_a <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a)
    return (intersection/union)
}

jaccard_b <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(b)
    return (intersection/union)
}

vector_list <- list()
for (name1 in names(ref_regulon_list)){
  vec <- vector()
  for (name2 in names(ref_regulon_list)){
    vec <- c(vec, jaccard(ref_regulon_list[[name1]], query_regulon_list[[name2]]))
  }
  vector_list[[name1]] <- data.frame(t(vec))
}
jaccard_matrix <- as.matrix(rbindlist(vector_list))
colnames(jaccard_matrix) <- names(ref_regulon_list)
rownames(jaccard_matrix) <- names(ref_regulon_list)
saveRDS(diag(jaccard_matrix), file='/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/SCENIC/jaccard_genes.RDS')
jaccard_matrix <- as.data.frame(jaccard_matrix)

jaccard_matrix <- round(jaccard_matrix,2)

library(reshape2)
library(ggplot2)
# Format matrix
jaccard_matrix$Multiome <- rownames(jaccard_matrix)
melted_jaccard_matrix <- melt(jaccard_matrix)
colnames(melted_jaccard_matrix)[2] <- 'SCENIC'
melted_jaccard_matrix$SCENIC <- factor(melted_jaccard_matrix$SCENIC, levels=unique(melted_jaccard_matrix$SCENIC))
melted_jaccard_matrix$Multiome <- factor(melted_jaccard_matrix$Multiome, levels=unique(melted_jaccard_matrix$Multiome))
# Create heatmap
ggheatmap <- ggplot(melted_jaccard_matrix, aes(SCENIC, Multiome, fill = value))+
   scale_fill_gradient2(low = "dodgerblue", high = "red", mid = "white", space = "Lab", 
    name="Jaccard") +
 geom_tile(color = "white")+
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 10, hjust = 1))+
 coord_fixed()
pdf('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/genes_multiome_vs_SCENIC.pdf')
ggheatmap
dev.off()
```

# D. Multiome

```{r}
ref_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/regulon_list.RDS')
sel_rel <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/HQ_regulons.RDS')
query_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/regulon_list.RDS')
sel_rel_2 <- sel_rel
sel_rel <- sel_rel[which(sel_rel %in% sel_rel_2)]
ref_regulon_list <- ref_regulon_list[sel_rel]
query_regulon_list <- query_regulon_list[sel_rel]

jaccard <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a) + length(b) - intersection
    return (intersection/union)
}

jaccard_a <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a)
    return (intersection/union)
}

jaccard_b <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(b)
    return (intersection/union)
}

vector_list <- list()
for (name1 in names(ref_regulon_list)){
  vec <- vector()
  for (name2 in names(ref_regulon_list)){
    vec <- c(vec, jaccard(ref_regulon_list[[name1]], query_regulon_list[[name2]]))
  }
  vector_list[[name1]] <- data.frame(t(vec))
}
jaccard_matrix <- as.matrix(rbindlist(vector_list))
colnames(jaccard_matrix) <- names(ref_regulon_list)
rownames(jaccard_matrix) <- names(ref_regulon_list)
saveRDS(diag(jaccard_matrix), file='/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/Multiome_jaccard_genes.RDS')
jaccard_matrix <- as.data.frame(jaccard_matrix)

jaccard_matrix <- round(jaccard_matrix,2)

library(reshape2)
library(ggplot2)
# Format matrix
jaccard_matrix$Multiome <- rownames(jaccard_matrix)
melted_jaccard_matrix <- melt(jaccard_matrix)
colnames(melted_jaccard_matrix)[2] <- 'SCENIC'
melted_jaccard_matrix$SCENIC <- factor(melted_jaccard_matrix$SCENIC, levels=unique(melted_jaccard_matrix$SCENIC))
melted_jaccard_matrix$Multiome <- factor(melted_jaccard_matrix$Multiome, levels=unique(melted_jaccard_matrix$Multiome))
# Create heatmap
ggheatmap <- ggplot(melted_jaccard_matrix, aes(SCENIC, Multiome, fill = value))+
   scale_fill_gradient2(low = "dodgerblue", high = "red", mid = "white", space = "Lab", 
    name="Jaccard") +
 geom_tile(color = "white")+
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 10, hjust = 1))+
 coord_fixed()
pdf('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/genes_multiome_vs_multiomes.pdf')
ggheatmap
dev.off()
```

# 4. Overlap between regions

## 0. Prepare multiome object

```{r}
library(SCopeLoomR)
path <- '/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/'
loom_path <- paste0(path,'SCENIC+_mouse_cortex_region_based.loom')
loom <- open_loom(loom_path)
cells_AUC_region <- getAUC(get_regulons_AUC(loom, column.attr.name='RegulonsAUC'))
cells_AUC_region <- cells_AUC_region[-which(rownames(cells_AUC_region) %in% out_extended),]
rownames(cells_AUC_region) <- gsub('_extended', '', rownames(cells_AUC_region) )
rownames(cells_AUC_region) <- gsub('_+_+', '_+', rownames(cells_AUC_region), fixed=TRUE)
rownames(cells_AUC_region) <- gsub('_-_+', '_-', rownames(cells_AUC_region), fixed=TRUE)
```

```{r}
# Get eRegulons
regulons <- get_regulons(loom, column.attr.name='Regulons')
regulon_list <- list()
for (row in rownames(regulons)){
  regulon_list[[row]] <- colnames(regulons)[which(regulons[row,] == 1)]
}
```

```{r}
out_extended <- vector()
for (name in names(regulon_list)[grep('extended', names(regulon_list))]){
  sub_name <- gsub('_extended', '', name)
  if (sub_name %in% names(regulon_list))
    out_extended <- c(out_extended , name)
}
out_extended <- c(out_extended, names(regulon_list)[grep('+_-', names(regulon_list), fixed=TRUE)], names(regulon_list)[grep('-_-', names(regulon_list), fixed=TRUE)])
```

```{r}
regulon_list <- regulon_list[-which(names(regulon_list) %in% out_extended)]
cells_AUC <- cells_AUC[-which(rownames(cells_AUC) %in% out_extended),]
names(regulon_list) <- gsub('_extended', '', names(regulon_list))
rownames(cells_AUC) <- gsub('_extended', '', rownames(cells_AUC))

names(regulon_list) <- gsub('_+_+', '_+', names(regulon_list), fixed=TRUE)
names(regulon_list) <- gsub('_-_+', '_-', names(regulon_list), fixed=TRUE)
rownames(cells_AUC) <- gsub('_+_+', '_+', rownames(cells_AUC), fixed=TRUE)
rownames(cells_AUC) <- gsub('_-_+', '_-', rownames(cells_AUC), fixed=TRUE)
```

```{r}
saveRDS(regulon_list, file=paste0(path,'regulon_list_regions.RDS'))
```

## A. ScoMAP

```{r}
ref_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/regulon_list_regions.RDS')
sel_rel <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/HQ_regulons.RDS')
query_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/ScoMAP/regulon_list_regions.RDS')
sel_rel_2 <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/ScoMAP/HQ_regulons.RDS')
sel_rel <- sel_rel[which(sel_rel %in% sel_rel_2)]
ref_regulon_list <- ref_regulon_list[sel_rel]
query_regulon_list <- query_regulon_list[sel_rel]

jaccard <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a) + length(b) - intersection
    return (intersection/union)
}

jaccard_a <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a)
    return (intersection/union)
}

jaccard_b <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(b)
    return (intersection/union)
}

vector_list <- list()
for (name1 in names(ref_regulon_list)){
  vec <- vector()
  for (name2 in names(ref_regulon_list)){
    vec <- c(vec, jaccard(ref_regulon_list[[name1]], query_regulon_list[[name2]]))
  }
  vector_list[[name1]] <- data.frame(t(vec))
}
jaccard_matrix <- as.matrix(rbindlist(vector_list))
colnames(jaccard_matrix) <- names(ref_regulon_list)
rownames(jaccard_matrix) <- names(ref_regulon_list)
saveRDS(diag(jaccard_matrix), file='/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/ScoMAP/jaccard_regions.RDS')
jaccard_matrix <- as.data.frame(jaccard_matrix)

jaccard_matrix <- round(jaccard_matrix,2)

library(reshape2)
library(ggplot2)
# Format matrix
jaccard_matrix$Multiome <- rownames(jaccard_matrix)
melted_jaccard_matrix <- melt(jaccard_matrix)
colnames(melted_jaccard_matrix)[2] <- 'ScoMAP'
melted_jaccard_matrix$ScoMAP <- factor(melted_jaccard_matrix$ScoMAP, levels=unique(melted_jaccard_matrix$ScoMAP))
melted_jaccard_matrix$Multiome <- factor(melted_jaccard_matrix$Multiome, levels=unique(melted_jaccard_matrix$Multiome))
# Create heatmap
ggheatmap <- ggplot(melted_jaccard_matrix, aes(ScoMAP, Multiome, fill = value))+
   scale_fill_gradient2(low = "dodgerblue", high = "red", mid = "white", space = "Lab", 
    name="Jaccard") +
 geom_tile(color = "white")+
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 10, hjust = 1))+
 coord_fixed()
pdf('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/regions_multiome_vs_ScoMAP.pdf')
ggheatmap
dev.off()
```


## B. FigR

```{r}
ref_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/regulon_list_regions.RDS')
sel_rel <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/HQ_regulons.RDS')
query_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/FigR/regulon_list_regions.RDS')
sel_rel_2 <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/FigR/HQ_regulons.RDS')
sel_rel <- sel_rel[which(sel_rel %in% sel_rel_2)]
ref_regulon_list <- ref_regulon_list[sel_rel]
query_regulon_list <- query_regulon_list[sel_rel]

jaccard <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a) + length(b) - intersection
    return (intersection/union)
}

jaccard_a <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a)
    return (intersection/union)
}

jaccard_b <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(b)
    return (intersection/union)
}

vector_list <- list()
for (name1 in names(ref_regulon_list)){
  vec <- vector()
  for (name2 in names(ref_regulon_list)){
    vec <- c(vec, jaccard(ref_regulon_list[[name1]], query_regulon_list[[name2]]))
  }
  vector_list[[name1]] <- data.frame(t(vec))
}
jaccard_matrix <- as.matrix(rbindlist(vector_list))
colnames(jaccard_matrix) <- names(ref_regulon_list)
rownames(jaccard_matrix) <- names(ref_regulon_list)
saveRDS(diag(jaccard_matrix), file='/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/FigR/jaccard_regions.RDS')
jaccard_matrix <- as.data.frame(jaccard_matrix)

jaccard_matrix <- round(jaccard_matrix,2)

library(reshape2)
library(ggplot2)
# Format matrix
jaccard_matrix$Multiome <- rownames(jaccard_matrix)
melted_jaccard_matrix <- melt(jaccard_matrix)
colnames(melted_jaccard_matrix)[2] <- 'FigR'
melted_jaccard_matrix$FigR <- factor(melted_jaccard_matrix$FigR, levels=unique(melted_jaccard_matrix$FigR))
melted_jaccard_matrix$Multiome <- factor(melted_jaccard_matrix$Multiome, levels=unique(melted_jaccard_matrix$Multiome))
# Create heatmap
ggheatmap <- ggplot(melted_jaccard_matrix, aes(FigR, Multiome, fill = value))+
   scale_fill_gradient2(low = "dodgerblue", high = "red", mid = "white", space = "Lab", 
    name="Jaccard") +
 geom_tile(color = "white")+
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 10, hjust = 1))+
 coord_fixed()
pdf('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/regions_multiome_vs_FigR.pdf')
ggheatmap
dev.off()
```



## C. SCENIC

```{r}
ref_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/regulon_list_regions.RDS')
sel_rel <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/HQ_regulons.RDS')
query_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/SCENIC/regulon_list_regions.RDS')
sel_rel_2 <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/SCENIC/HQ_regulons.RDS')
sel_rel <- sel_rel[which(sel_rel %in% sel_rel_2)]
ref_regulon_list <- ref_regulon_list[sel_rel]
query_regulon_list <- query_regulon_list[sel_rel]

jaccard <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a) + length(b) - intersection
    return (intersection/union)
}

jaccard_a <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a)
    return (intersection/union)
}

jaccard_b <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(b)
    return (intersection/union)
}

vector_list <- list()
for (name1 in names(ref_regulon_list)){
  vec <- vector()
  for (name2 in names(ref_regulon_list)){
    vec <- c(vec, jaccard(ref_regulon_list[[name1]], query_regulon_list[[name2]]))
  }
  vector_list[[name1]] <- data.frame(t(vec))
}
jaccard_matrix <- as.matrix(rbindlist(vector_list))
colnames(jaccard_matrix) <- names(ref_regulon_list)
rownames(jaccard_matrix) <- names(ref_regulon_list)
saveRDS(diag(jaccard_matrix), file='/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/SCENIC/jaccard_regions.RDS')
jaccard_matrix <- as.data.frame(jaccard_matrix)

jaccard_matrix <- round(jaccard_matrix,2)

library(reshape2)
library(ggplot2)
# Format matrix
jaccard_matrix$Multiome <- rownames(jaccard_matrix)
melted_jaccard_matrix <- melt(jaccard_matrix)
colnames(melted_jaccard_matrix)[2] <- 'SCENIC'
melted_jaccard_matrix$SCENIC <- factor(melted_jaccard_matrix$SCENIC, levels=unique(melted_jaccard_matrix$SCENIC))
melted_jaccard_matrix$Multiome <- factor(melted_jaccard_matrix$Multiome, levels=unique(melted_jaccard_matrix$Multiome))
# Create heatmap
ggheatmap <- ggplot(melted_jaccard_matrix, aes(SCENIC, Multiome, fill = value))+
   scale_fill_gradient2(low = "dodgerblue", high = "red", mid = "white", space = "Lab", 
    name="Jaccard") +
 geom_tile(color = "white")+
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 10, hjust = 1))+
 coord_fixed()
pdf('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/regions_multiome_vs_SCENIC.pdf')
ggheatmap
dev.off()
```

## D. Multiome

```{r}
ref_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/regulon_list_regions.RDS')
sel_rel <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/HQ_regulons.RDS')
query_regulon_list <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/regulon_list_regions.RDS')
sel_rel_2 <- sel_rel
sel_rel <- sel_rel[which(sel_rel %in% sel_rel_2)]
ref_regulon_list <- ref_regulon_list[sel_rel]
query_regulon_list <- query_regulon_list[sel_rel]

jaccard <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a) + length(b) - intersection
    return (intersection/union)
}

jaccard_a <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(a)
    return (intersection/union)
}

jaccard_b <- function(a, b) {
    intersection = length(intersect(a, b))
    union = length(b)
    return (intersection/union)
}

vector_list <- list()
for (name1 in names(ref_regulon_list)){
  vec <- vector()
  for (name2 in names(ref_regulon_list)){
    vec <- c(vec, jaccard(ref_regulon_list[[name1]], query_regulon_list[[name2]]))
  }
  vector_list[[name1]] <- data.frame(t(vec))
}
jaccard_matrix <- as.matrix(rbindlist(vector_list))
colnames(jaccard_matrix) <- names(ref_regulon_list)
rownames(jaccard_matrix) <- names(ref_regulon_list)
saveRDS(diag(jaccard_matrix), file='/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/Multiome_jaccard_regions.RDS')
jaccard_matrix <- as.data.frame(jaccard_matrix)

jaccard_matrix <- round(jaccard_matrix,2)

library(reshape2)
library(ggplot2)
# Format matrix
jaccard_matrix$Multiome <- rownames(jaccard_matrix)
melted_jaccard_matrix <- melt(jaccard_matrix)
colnames(melted_jaccard_matrix)[2] <- 'FigR'
melted_jaccard_matrix$FigR <- factor(melted_jaccard_matrix$FigR, levels=unique(melted_jaccard_matrix$FigR))
melted_jaccard_matrix$Multiome <- factor(melted_jaccard_matrix$Multiome, levels=unique(melted_jaccard_matrix$Multiome))
# Create heatmap
ggheatmap <- ggplot(melted_jaccard_matrix, aes(FigR, Multiome, fill = value))+
   scale_fill_gradient2(low = "dodgerblue", high = "red", mid = "white", space = "Lab", 
    name="Jaccard") +
 geom_tile(color = "white")+
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 10, hjust = 1))+
 coord_fixed()
pdf('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/regions_multiome_vs_multiome.pdf')
ggheatmap
dev.off()
```

# 5. Make jaccard violin plots (genes)

```{r}
TFs <- list()
TFs[['ScoMAP']] <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/ScoMAP/jaccard_genes.RDS')
TFs[['FigR']] <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/FigR/jaccard_genes.RDS')
TFs[['SCENIC']] <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/SCENIC/jaccard_genes.RDS')
```

```{r}
x <- TFs
dt <- data.frame()
for (name in names(x)){
  print(name)
  print(median(x[[name]]))
  print(mean((x[[name]])))
  z <- as.data.frame(cbind(x[[name]], rep(name, length(x[[name]]))))
  colnames(z) <-  c('Value', 'Method')
  dt <- rbind(dt, z)
}
```

```{r}
library(RColorBrewer)
library(ggplot2)
myColors <- c("SCENIC"= 'red',"FigR"= 'purple', "ScoMAP"= 'dodgerblue')
colScale <- scale_fill_manual(name = "grp",values = myColors, guide='none') 
dt <- as.data.frame(dt)
dt[,1] <- as.numeric(dt[,1])
dt[,2] <- as.factor(dt[,2])
dt[,2] <- factor(dt[,2], levels = c('FigR', 'SCENIC',  'ScoMAP'))
pdf('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/jaccard_genes.pdf')
ggplot(dt,aes(x = Method, y = Value, fill= Method)) + geom_boxplot() + theme_bw() + xlab("Method") + ylab('Jaccard') + theme(axis.text.x = element_text(angle = 45, hjust=1))  + colScale
#ggplot(dt,aes(x = reorder(Method, -Value, FUN = median), y = Value, fill=reorder(Method, -Value, FUN = median))) + geom_boxplot() + theme_bw() + xlab("Model") + ylab('# Genes') + theme(axis.text.x = element_text(angle = 45, hjust=1))  + colScale + scale_y_continuous(trans='log10')
dev.off()
```

# 6. Make jaccard violin plots (regions)

```{r}
TFs <- list()
TFs[['ScoMAP']] <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/ScoMAP/jaccard_regions.RDS')
TFs[['FigR']] <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/FigR/jaccard_regions.RDS')
TFs[['SCENIC']] <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/SCENIC/jaccard_regions.RDS')
```

```{r}
x <- TFs
dt <- data.frame()
for (name in names(x)){
  print(name)
  print(median(x[[name]]))
  print(mean((x[[name]])))
  z <- as.data.frame(cbind(x[[name]], rep(name, length(x[[name]]))))
  colnames(z) <-  c('Value', 'Method')
  dt <- rbind(dt, z)
}
```

```{r}
library(RColorBrewer)
library(ggplot2)
myColors <- c("SCENIC"= 'red',"FigR"= 'purple', "ScoMAP"= 'dodgerblue')
colScale <- scale_fill_manual(name = "grp",values = myColors, guide='none') 
dt <- as.data.frame(dt)
dt[,1] <- as.numeric(dt[,1])
dt[,2] <- as.factor(dt[,2])
dt[,2] <- factor(dt[,2], levels = c('FigR', 'SCENIC',  'ScoMAP'))
pdf('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/jaccard_regions.pdf')
ggplot(dt,aes(x = Method, y = Value, fill= Method)) + geom_boxplot() + theme_bw() + xlab("Method") + ylab('Jaccard') + theme(axis.text.x = element_text(angle = 45, hjust=1))  + colScale
#ggplot(dt,aes(x = reorder(Method, -Value, FUN = median), y = Value, fill=reorder(Method, -Value, FUN = median))) + geom_boxplot() + theme_bw() + xlab("Model") + ylab('# Genes') + theme(axis.text.x = element_text(angle = 45, hjust=1))  + colScale + scale_y_continuous(trans='log10')
dev.off()
```

# 7. Dimesionality reduction

## A. Multiome

```{r}
path <- '/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/'
cells_AUC <- readRDS(paste0(path, 'cells_AUC_genebased.RDS'))
sel_rel <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/TEW_cortex/scenicplus_v10_v2/grnboost_autoreg/HQ_regulons.RDS')
cells_AUC <- cells_AUC[sel_rel,]
library(SCopeLoomR)
library(AUCell)
library(SCENIC)
library(Seurat)
loom_path <- paste0(path, 'SCENIC+_mouse_cortex_gene_based_AE.loom')
loom <- open_loom(loom_path)
cell_data <- get_cell_annotation(loom)
cell_data$Pseudobulk <- cell_data$GEX_conserved_cell_type
x <- CreateSeuratObject(cells_AUC, meta.data=cell_data)
x
```

```{r}
x <- ScaleData(x)
x <- FindVariableFeatures(x) 
x <- RunPCA(x)
ElbowPlot(x)
```

```{r}
x <- RunUMAP(x, dims = 1:20)
DimPlot(x, reduction = "umap", group.by = 'Pseudobulk')
```

```{r}
library(harmony)
x <- RunHarmony(
  object = x,
  dims.use=1:20,
  group.by.vars = c("ACC_sample_id")
)

x <- RunUMAP(x, dims=1:20, reduction = "harmony", reduction.name = "umap.harmony")
DimPlot(x, group.by = "GEX_consensus_cell_type", label = TRUE, reduction='umap.harmony') + NoLegend()
```

```{r}
# Load functions
gene_umap <- x@reductions$umap.harmony@cell.embeddings
colnames(gene_umap) <- c('UMAP_1', 'UMAP_2')
cell_plot_data <- cbind(gene_umap, cell_data[rownames(gene_umap),])
library(ggplot2)
colvar <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/cross_species_plots/colvar_mouse.RDS')
path <- '/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/'
source('/staging/leuven/stg_00002/lcb/cbravo/software/plotting_aux.R')
plot <- ggplot(cell_plot_data, aes(x=UMAP_1, y=UMAP_2, colour=GEX_consensus_cell_type)) + geom_point(size = 0.2) + theme_classic() + theme(legend.position = "none") + 
  scale_fill_manual(values = colvar)
ggplot(cell_plot_data, aes(x=UMAP_1, y=UMAP_2, colour=GEX_consensus_cell_type)) + geom_point(size = 0.2) + theme_classic() + theme(legend.position = "none") + labs(x = NULL, y = NULL) + 
  guides(x = "none", y = "none") + scale_color_manual(values = colvar)
ggsave(filename = paste0(path, 'Multiome_Mouse_UMAP_no_labels.png'), device='png', bg = "transparent",
       width=7, height=7)
pdf(paste0(path, 'Multiome_Mouse_UMAP_with_labels.pdf'))
LabelClusters(plot, 'GEX_consensus_cell_type', split.by ='GEX_consensus_cell_type', box=FALSE, repel=TRUE)  + scale_color_manual(values = colvar)
dev.off()
```

## B. ScoMAP

```{r}
path <- '/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/ScoMAP/'
cells_AUC <- readRDS(paste0(path, 'cells_AUC_genebased.RDS'))
sel_rel <- readRDS(paste0(path,'HQ_regulons.RDS'))
cells_AUC <- cells_AUC[sel_rel,]
library(SCopeLoomR)
library(AUCell)
library(SCENIC)
library(Seurat)
loom_path <- paste0(path, 'SCENIC+_gene_based.loom')
loom <- open_loom(loom_path)
cell_data <- get_cell_annotation(loom)
cell_data$Pseudobulk <- cell_data$GEX_conserved_cell_type
x <- CreateSeuratObject(cells_AUC, meta.data=cell_data)
x
```

```{r}
x <- ScaleData(x)
x <- FindVariableFeatures(x) 
x <- RunPCA(x)
ElbowPlot(x)
```

```{r}
x <- RunUMAP(x, dims = 1:20)
DimPlot(x, reduction = "umap", group.by = 'Pseudobulk')
```

```{r}
library(harmony)
x <- RunHarmony(
  object = x,
  dims.use=1:10,
  group.by.vars = c("ACC_sample_id")
)

x <- RunUMAP(x, dims=1:10, reduction = "harmony", reduction.name = "umap.harmony")
DimPlot(x, group.by = "GEX_consensus_cell_type", label = TRUE, reduction='umap.harmony') + NoLegend()
```

```{r}
# Load functions
gene_umap <- x@reductions$umap@cell.embeddings
colnames(gene_umap) <- c('UMAP_1', 'UMAP_2')
cell_plot_data <- cbind(gene_umap, cell_data[rownames(gene_umap),])
library(ggplot2)
colvar <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/cross_species_plots/colvar_mouse.RDS')
path <- '/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/'
source('/staging/leuven/stg_00002/lcb/cbravo/software/plotting_aux.R')
plot <- ggplot(cell_plot_data, aes(x=UMAP_1, y=UMAP_2, colour=GEX_consensus_cell_type)) + geom_point(size = 0.2) + theme_classic() + theme(legend.position = "none") + 
  scale_fill_manual(values = colvar)
ggplot(cell_plot_data, aes(x=UMAP_1, y=UMAP_2, colour=GEX_consensus_cell_type)) + geom_point(size = 0.2) + theme_classic() + theme(legend.position = "none") + labs(x = NULL, y = NULL) + 
  guides(x = "none", y = "none") + scale_color_manual(values = colvar)
ggsave(filename = paste0(path, 'ScoMAP_Mouse_UMAP_no_labels.png'), device='png', bg = "transparent",
       width=7, height=7)
pdf(paste0(path, 'ScoMAP_Mouse_UMAP_with_labels.pdf'))
LabelClusters(plot, 'GEX_consensus_cell_type', split.by ='GEX_consensus_cell_type', box=FALSE, repel=TRUE)  + scale_color_manual(values = colvar)
dev.off()
```

## C. FigR

```{r}
path <- '/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/FigR/'
cells_AUC <- readRDS(paste0(path, 'cells_AUC_genebased.RDS'))
sel_rel <- readRDS(paste0(path,'HQ_regulons.RDS'))
cells_AUC <- cells_AUC[sel_rel,]
library(SCopeLoomR)
library(AUCell)
library(SCENIC)
library(Seurat)
loom_path <- paste0(path, 'SCENIC+_gene_based.loom')
loom <- open_loom(loom_path)
cell_data <- get_cell_annotation(loom)
cell_data$Pseudobulk <- cell_data$GEX_conserved_cell_type
x <- CreateSeuratObject(cells_AUC, meta.data=cell_data)
x
```

```{r}
x <- ScaleData(x)
x <- FindVariableFeatures(x) 
x <- RunPCA(x)
ElbowPlot(x)
```

```{r}
x <- RunUMAP(x, dims = 1:20)
DimPlot(x, reduction = "umap", group.by = 'Pseudobulk')
```

```{r}
library(harmony)
x <- RunHarmony(
  object = x,
  dims.use=1:20,
  group.by.vars = c("ACC_sample_id")
)

x <- RunUMAP(x, dims=1:20, reduction = "harmony", reduction.name = "umap.harmony")
DimPlot(x, group.by = "GEX_consensus_cell_type", label = TRUE, reduction='umap.harmony') + NoLegend()
```

```{r}
# Load functions
gene_umap <- x@reductions$umap@cell.embeddings
colnames(gene_umap) <- c('UMAP_1', 'UMAP_2')
cell_plot_data <- cbind(gene_umap, cell_data[rownames(gene_umap),])
library(ggplot2)
colvar <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/cross_species_plots/colvar_mouse.RDS')
path <- '/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/'
source('/staging/leuven/stg_00002/lcb/cbravo/software/plotting_aux.R')
plot <- ggplot(cell_plot_data, aes(x=UMAP_1, y=UMAP_2, colour=GEX_consensus_cell_type)) + geom_point(size = 0.2) + theme_classic() + theme(legend.position = "none") + 
  scale_fill_manual(values = colvar)
ggplot(cell_plot_data, aes(x=UMAP_1, y=UMAP_2, colour=GEX_consensus_cell_type)) + geom_point(size = 0.2) + theme_classic() + theme(legend.position = "none") + labs(x = NULL, y = NULL) + 
  guides(x = "none", y = "none") + scale_color_manual(values = colvar)
ggsave(filename = paste0(path, 'FigR_Mouse_UMAP_no_labels.png'), device='png', bg = "transparent",
       width=7, height=7)
pdf(paste0(path, 'FigR_Mouse_UMAP_with_labels.pdf'))
LabelClusters(plot, 'GEX_consensus_cell_type', split.by ='GEX_consensus_cell_type', box=FALSE, repel=TRUE)  + scale_color_manual(values = colvar)
dev.off()
```

## D. SCENIC

```{r}
path <- '/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/SCENIC/SCENIC/'
cells_AUC <- readRDS(paste0(path, 'cells_AUC_genebased.RDS'))
sel_rel <- readRDS(paste0(path,'HQ_regulons.RDS'))
cells_AUC <- cells_AUC[sel_rel,]
library(SCopeLoomR)
library(AUCell)
library(SCENIC)
library(Seurat)
loom_path <- paste0(path, 'SCENIC+_gene_based.loom')
loom <- open_loom(loom_path)
cell_data <- get_cell_annotation(loom)
cell_data$Pseudobulk <- cell_data$GEX_conserved_cell_type
x <- CreateSeuratObject(cells_AUC, meta.data=cell_data)
x
```

```{r}
x <- ScaleData(x)
x <- FindVariableFeatures(x) 
x <- RunPCA(x)
ElbowPlot(x)
```

```{r}
x <- RunUMAP(x, dims = 1:20)
DimPlot(x, reduction = "umap", group.by = 'Pseudobulk')
```

```{r}
library(harmony)
x <- RunHarmony(
  object = x,
  dims.use=1:20,
  group.by.vars = c("ACC_sample_id")
)

x <- RunUMAP(x, dims=1:20, reduction = "harmony", reduction.name = "umap.harmony")
DimPlot(x, group.by = "GEX_consensus_cell_type", label = TRUE, reduction='umap.harmony') + NoLegend()
```

```{r}
# Load functions
gene_umap <- x@reductions$umap@cell.embeddings
colnames(gene_umap) <- c('UMAP_1', 'UMAP_2')
cell_plot_data <- cbind(gene_umap, cell_data[rownames(gene_umap),])
library(ggplot2)
colvar <- readRDS('/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/cross_species_plots/colvar_mouse.RDS')
path <- '/staging/leuven/stg_00002/lcb/cbravo/Multiomics_pipeline/analysis/10x_multiome_mouse_cortex/pair_benchmark/plots/'
source('/staging/leuven/stg_00002/lcb/cbravo/software/plotting_aux.R')
plot <- ggplot(cell_plot_data, aes(x=UMAP_1, y=UMAP_2, colour=GEX_consensus_cell_type)) + geom_point(size = 0.2) + theme_classic() + theme(legend.position = "none") + 
  scale_fill_manual(values = colvar)
ggplot(cell_plot_data, aes(x=UMAP_1, y=UMAP_2, colour=GEX_consensus_cell_type)) + geom_point(size = 0.2) + theme_classic() + theme(legend.position = "none") + labs(x = NULL, y = NULL) + 
  guides(x = "none", y = "none") + scale_color_manual(values = colvar)
ggsave(filename = paste0(path, 'SCENIC_Mouse_UMAP_no_labels.png'), device='png', bg = "transparent",
       width=7, height=7)
pdf(paste0(path, 'SCENIC_Mouse_UMAP_with_labels.pdf'))
LabelClusters(plot, 'GEX_consensus_cell_type', split.by ='GEX_consensus_cell_type', box=FALSE, repel=TRUE)  + scale_color_manual(values = colvar)
dev.off()
```

